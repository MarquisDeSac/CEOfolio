---
import StandardLayout from '~/layouts/StandardLayout.astro'
import BaseLayout from '~/layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'
import { experiences } from '~/data/experiences'
import { parcours } from '~/data/parcours'

// 1. Fetch All Data
const projects = await getCollection('projects')

// 2. Define Categories and their Keywords (for auto-sorting)
const categories = {
  'Moteur & Jeu Vidéo': {
    color: 'neon-pink',
    keywords: ['Unity', 'Godot', 'Unreal', 'Game', 'Jeu', 'VR', 'AR', 'XR', 'WebGL', 'Processing', 'Shader', '3D', '2D', 'Level', 'Asset', 'Balance', 'Spatial Audio', 'Locomotion']
  },
  'Programmation & Backend': {
    color: 'neon-blue',
    keywords: ['C', 'C#', 'C++', 'Java', 'Python', 'Script', 'Spring', 'SQL', 'Data', 'API', 'Rest', 'Algorithm', 'Structure', 'POO']
  },
  'Web & Tools': {
    color: 'sunset-purple',
    keywords: ['HTML', 'CSS', 'Git', 'Version', 'Thymeleaf', 'JS', 'Interop', 'Voice', 'STT', 'TTS']
  },
  'Architecture & Gestion': {
    color: 'neon-pink', // Recycle pink or pick new
    keywords: ['MVC', 'Pattern', 'Agile', 'Scrum', 'Chef', 'Gestion', 'Documentation', 'GDD', 'State Machine']
  },
  'Design & Soft Skills': {
    color: 'neon-blue',
    keywords: ['UI', 'UX', 'Design', 'Communication', 'Public', 'English', 'Korean', 'Interculturel', 'Social', 'Audio', 'Narrative', 'Gamification', 'Serious Game']
  }
}

// 3. Aggregate Skills
// Map<SkillName, ListOfVariousItems>
const skillMap = new Map()

function registerSkill(skillName, sourceItem, type) {
  const normSkill = skillName.trim()
  if (!skillMap.has(normSkill)) {
    skillMap.set(normSkill, { name: normSkill, items: [] })
  }
  skillMap.get(normSkill).items.push({ ...sourceItem, sourceType: type })
}

// Process Projects
projects.forEach(p => {
  if (p.data.skills) {
    p.data.skills.forEach(s => registerSkill(s, { title: p.data.id, link: `/fr/projects/${p.data.id}` }, 'Project'))
  }
})

// Process Experiences
experiences.fr.forEach(e => {
  if (e.skills) {
    e.skills.forEach(s => registerSkill(s, { title: e.role + ' @ ' + e.company, link: '/fr/experiences' }, 'Exp'))
  }
})

// Process Parcours
parcours.fr.forEach(p => {
  if (p.skills) {
    p.skills.forEach(s => registerSkill(s, { title: p.title, link: '/fr/parcours' }, 'Education'))
  }
})

// 4. Sort Skills into Categories
const categorizedSkills = {}
Object.keys(categories).forEach(k => categorizedSkills[k] = [])

skillMap.forEach((value, key) => {
  let matched = false
  for (const [catName, catConfig] of Object.entries(categories)) {
    if (catConfig.keywords.some(k => key.toLowerCase().includes(k.toLowerCase()))) {
      categorizedSkills[catName].push(value)
      matched = true
      break // Assign to first matching category
    }
  }
  if (!matched) {
    categorizedSkills['Design & Soft Skills'].push(value)
  }
})

const title = "Compétences"
const subtitle = "Stack Technique & Savoir-Être"
---

<BaseLayout
  title={title}
  description={subtitle}
  bgType="bit-rain"
  ogImage={false}
>
  <StandardLayout
    title={title}
    subtitle={subtitle}
    isCentered={true}
    articleClass="max-w-6xl!"
  >
    <div slot="article" class="py-10">
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {Object.entries(categorizedSkills).map(([catName, skills]) => (
          skills.length > 0 && (
            <div class={`p-6 rounded-2xl bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 flex flex-col gap-4 hover:border-${categories[catName].color} transition-colors group relative overflow-hidden`}>
              
              <!-- Header -->
              <div class="flex items-center gap-3 mb-2 relative z-10">
                <div class={`w-3 h-8 rounded-full bg-${categories[catName].color} flex-shrink-0`}></div>
                <h3 class="text-xl font-bold u-text-main">{catName}</h3>
              </div>

              <!-- Skills Cloud -->
              <div class="flex flex-wrap gap-2 relative z-10">
                {skills.sort((a,b) => b.items.length - a.items.length).map(skill => (
                  <button 
                    onclick={`document.getElementById('modal-${skill.name.replace(/[^a-zA-Z0-9-]/g, '-')}')?.showModal()`}
                    class={`px-3 py-1.5 text-xs font-medium rounded-lg border border-black/10 dark:border-white/10 bg-white/50 dark:bg-black/20 u-text-muted hover:text-white hover:bg-${categories[catName].color} hover:border-${categories[catName].color} transition-all cursor-pointer text-left relative group/skill`}
                  >
                    {skill.name}
                    {skill.items.length > 1 && (
                      <span class="absolute -top-1 -right-1 w-2 h-2 rounded-full bg-white opacity-50 shadow-sm"></span>
                    )}
                  </button>
                ))}
              </div>

              <!-- Bg Glow -->
              <div class={`absolute top-0 right-0 w-32 h-32 bg-${categories[catName].color} opacity-5 blur-3xl rounded-full group-hover:opacity-10 transition-opacity`}></div>
            </div>
          )
        ))}
      </div>

    </div>

    <!-- Modals (Generated for each skill) -->
    {Array.from(skillMap.values()).map(skill => (
      <dialog id={`modal-${skill.name.replace(/[^a-zA-Z0-9-]/g, '-')}`} class="backdrop:bg-black/80 backdrop:backdrop-blur-sm bg-transparent p-0 m-auto max-w-lg w-full rounded-2xl shadow-2xl open:animate-fade-in z-50">
        <div class="bg-[#FCFCFC] dark:bg-[#0c0c0c] border border-black/10 dark:border-white/10 p-6 rounded-2xl relative overflow-hidden">
            
            <form method="dialog">
              <button class="absolute top-4 right-4 u-text-main opacity-50 hover:opacity-100 transition-opacity cursor-pointer z-50">
                <div class="i-ri-close-line text-2xl"></div>
              </button>
            </form>

            <h3 class="text-2xl font-bold u-text-main mb-6 pr-8">
              Projets impliquant <span class="text-transparent bg-clip-text bg-gradient-to-r from-neon-blue to-neon-pink">{skill.name}</span>
            </h3>

            <div class="flex flex-col gap-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
              {skill.items.map(item => (
                <a href={item.link} class="flex items-center gap-4 p-3 rounded-xl bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 transition-colors group no-underline border border-transparent hover:border-black/5 dark:hover:border-white/5">
                  <div class={`p-2 rounded-lg ${item.sourceType === 'Project' ? 'bg-neon-blue/20 text-neon-blue' : item.sourceType === 'Exp' ? 'bg-neon-pink/20 text-neon-pink' : 'bg-sunset-purple/20 text-sunset-purple'}`}>
                    <div class={item.sourceType === 'Project' ? 'i-ri-folder-line' : item.sourceType === 'Exp' ? 'i-ri-briefcase-line' : 'i-ri-graduation-cap-line'}></div>
                  </div>
                  <div class="flex flex-col">
                    <span class="font-medium u-text-main group-hover:text-neon-blue transition-colors">{item.title}</span>
                    <span class="text-xs opacity-50 uppercase tracking-widest u-text-main">{item.sourceType}</span>
                  </div>
                  <div class="ml-auto i-ri-arrow-right-s-line opacity-30 group-hover:opacity-100 u-text-main transition-all group-hover:-translate-x-1"></div>
                </a>
              ))}
            </div>

        </div>
      </dialog>
    ))}

  </StandardLayout>
</BaseLayout>

<style>
  dialog[open] {
    animation: zoom-in 0.2s ease-out;
  }
  @keyframes zoom-in {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #8884;
    border-radius: 3px;
  }
</style>
